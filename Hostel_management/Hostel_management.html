<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Hostel Sentinel ‚Äî AI Dashboard (single-file)</title>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
  /* Neo-Glass Emerald/Teal Theme - Single-file styles */
  :root{
    --bg1: #021617;
    --bg2: #042c2b;
    --glass: rgba(255,255,255,0.04);
    --glass-strong: rgba(255,255,255,0.08);
    --emerald: #10b981;
    --teal: #14b8a6;
    --muted: rgba(255,255,255,0.75);
    --accent: linear-gradient(90deg,var(--emerald),var(--teal));
  }
  html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:white}
  .app{max-width:1200px;margin:18px auto;padding:18px;display:grid;grid-template-rows:auto 1fr;gap:12px}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:baseline;gap:12px}
  .logo {font-weight:800;font-size:18px;color:var(--emerald)}
  .subtitle{color:var(--muted);font-size:12px}
  .top-actions{display:flex;gap:10px;align-items:center}
  .btn{background:var(--accent);border:0;padding:8px 12px;border-radius:10px;color:#042;cursor:pointer;font-weight:700}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;cursor:pointer;color:var(--muted)}
  .layout{display:grid;grid-template-columns:260px 1fr;gap:12px}
  .sidebar{padding:12px;border-radius:12px;background:var(--glass);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,0.04)}
  .side-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;cursor:pointer;color:var(--muted)}
  .side-item.active{background:linear-gradient(90deg, rgba(16,185,129,0.12), rgba(20,184,166,0.06));color:white}
  .glass{padding:12px;border-radius:12px;background:var(--glass);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,0.06)}
  .muted{color:var(--muted)}
  .role-pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);font-weight:700}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .grid-2{display:grid;grid-template-columns:1fr 360px;gap:12px}
  .stat{display:flex;gap:12px;align-items:center}
  .stat-icon{width:44px;height:44px;border-radius:10px;background:rgba(255,255,255,0.04);display:grid;place-items:center}
  .room-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:8px}
  .room-card{padding:8px;border-radius:8px;text-align:center;border:1px solid rgba(255,255,255,0.03);cursor:pointer;transition:transform .12s ease, box-shadow .12s ease}
  .room-card:hover{transform:translateY(-6px);box-shadow:0 10px 30px rgba(0,0,0,0.4)}
  .room-green{background:rgba(16,185,129,0.06);border-color:rgba(16,185,129,0.12)}
  .room-yellow{background:rgba(250,204,21,0.06);border-color:rgba(250,204,21,0.12)}
  .room-red{background:rgba(239,68,68,0.06);border-color:rgba(239,68,68,0.12)}
  .pill{padding:6px 8px;border-radius:10px}
  .pill.red{background:rgba(239,68,68,0.12);color:#ffb4b4;font-weight:700}
  .pill.yellow{background:rgba(250,204,21,0.12);color:#fff1b8;font-weight:700}
  .insight{padding:10px;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));margin-bottom:8px}
  .chat-box{display:flex;flex-direction:column;gap:8px}
  .chat-log{height:180px;overflow:auto;padding:8px;border-radius:8px;background:rgba(0,0,0,0.2)}
  .input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:white}
  .small{font-size:12px;color:var(--muted)}
  .heatmap{display:grid;grid-template-columns:repeat(8,24px);gap:4px}
  .heat{width:24px;height:24px;border-radius:4px}
  footer{margin-top:12px;color:var(--muted);font-size:12px;text-align:center}
  @media (max-width:920px){ .layout{grid-template-columns:1fr} .grid-2{grid-template-columns:1fr} .grid-3{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="brand">
      <div class="logo">Smart Hostel Sentinel</div>
      <div class="subtitle">AI Ops ¬∑ Neo-Glass ¬∑ Demo</div>
    </div>
    <div class="top-actions">
      <div id="statusArea" class="muted small"></div>
      <div id="authArea"></div>
    </div>
  </div>

  <div class="layout">
    <!-- SIDEBAR -->
    <div class="sidebar glass">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div>
          <div style="font-weight:800">Dashboard</div>
          <div class="muted small">Hostel overview</div>
        </div>
        <div id="roleBadge" class="role-pill">guest</div>
      </div>

      <div id="menu">
        <div class="side-item active" data-view="dashboard">Overview</div>
        <div class="side-item" data-view="map">Rooms</div>
        <div class="side-item" data-view="issues">Issues</div>
        <div class="side-item" data-view="ai">AI Insights</div>
        <div class="side-item" data-view="admin" data-roles="supervisor,director">Admin</div>
      </div>

      <div style="margin-top:12px">
        <div class="glass" style="padding:10px">
          <div style="font-size:13px;color:var(--muted)">Quick controls</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="ghost" id="btnExport">Export</button>
            <button class="ghost" id="btnReset">Reset</button>
          </div>
          <div style="margin-top:10px" class="small muted">Tip: Inspect AI panel for predictions & alerts.</div>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div>
      <!-- DYNAMIC CONTENT -->
      <div id="contentArea"></div>

      <footer>
        Demo ‚Ä¢ Data in browser localStorage ‚Ä¢ AI = lightweight heuristics & summarizers
      </footer>
    </div>
  </div>
</div>

<script>
/* ============================
  Single-file Smart Hostel App
  - localStorage backed
  - roles & permissions
  - issue reporting
  - charts via Chart.js
  - AI features: prediction, anomaly detection, NL search, chat assistant
  ============================ */

/* ---------- Storage keys ---------- */
const LS_ROOMS = 'sh_rooms_v2';
const LS_ISSUES = 'sh_issues_v2';
const LS_USER = 'sh_user_v2';

/* ---------- Seed data (rooms + users simulated) ---------- */
function seedRoomsIfNeeded(){
  if (localStorage.getItem(LS_ROOMS)) return;
  const blocks = ['A','B','C'];
  const rooms = [];
  const ts = new Date().toISOString();
  blocks.forEach(b=>{
    for(let f=1; f<=3; f++){
      const floor = `Floor${f}`;
      for(let r=1; r<=8; r++){
        rooms.push({ id: `${b}-${floor}-R${r}`, block: b, floor, number: r, status: 'green', last_updated: ts });
      }
    }
  });
  localStorage.setItem(LS_ROOMS, JSON.stringify(rooms));
}
function seedIssuesIfNeeded(){
  if (localStorage.getItem(LS_ISSUES)) return;
  const issues = [];
  // small seed of sample historic events for charts
  const now = Date.now();
  // create sample issues on different dates
  for(let i=0;i<30;i++){
    if (Math.random() < 0.25){
      const rid = randomRoomId();
      const created = new Date(now - Math.floor(Math.random()*20)*24*3600*1000).toISOString();
      issues.push({ id: uid(), title: `Auto-sampled issue ${i}`, description: 'sample', room_id: rid, reporter: 'student'+(1+Math.floor(Math.random()*5)), severity: Math.random()<0.3?'red':'yellow', status: 'resolved', created_at: created, deadline: new Date(new Date(created).getTime()+30*24*3600*1000).toISOString(), resolved_at: new Date(new Date(created).getTime()+2*24*3600*1000).toISOString() });
    }
  }
  localStorage.setItem(LS_ISSUES, JSON.stringify(issues));
}
function randomRoomId(){
  const rooms = JSON.parse(localStorage.getItem(LS_ROOMS) || '[]');
  if (!rooms.length) return 'A-Floor1-R1';
  return rooms[Math.floor(Math.random()*rooms.length)].id;
}
function uid(){ return Math.random().toString(36).slice(2,9); }

/* ---------- Load/Save helpers ---------- */
function loadRooms(){ return JSON.parse(localStorage.getItem(LS_ROOMS) || '[]'); }
function saveRooms(r){ localStorage.setItem(LS_ROOMS, JSON.stringify(r)); }
function loadIssues(){ return JSON.parse(localStorage.getItem(LS_ISSUES) || '[]'); }
function saveIssues(i){ localStorage.setItem(LS_ISSUES, JSON.stringify(i)); }
function loadUser(){ return JSON.parse(localStorage.getItem(LS_USER) || 'null'); }
function saveUser(u){ localStorage.setItem(LS_USER, JSON.stringify(u)); }

/* ---------- Initialize seeds ---------- */
seedRoomsIfNeeded();
seedIssuesIfNeeded();

/* ---------- App State ---------- */
let state = {
  view: 'dashboard',
  user: loadUser(),
  rooms: loadRooms(),
  issues: loadIssues(),
  insights: [],
  charts: {},
};

/* ---------- Utilities ---------- */
function nowISO(){ return new Date().toISOString(); }
function addDaysISO(d){ return new Date(Date.now() + d*24*3600*1000).toISOString(); }

/* ---------- UI helpers ---------- */
function $(sel){ return document.querySelector(sel); }
function $all(sel){ return Array.from(document.querySelectorAll(sel)); }
function setStatus(text){ $('#statusArea').innerText = text; }

/* ---------- Menu wiring ---------- */
function setupMenu(){
  $all('.side-item').forEach(el=>{
    el.onclick = ()=>{
      const view = el.dataset.view;
      state.view = view;
      $all('.side-item').forEach(x=>x.classList.remove('active'));
      el.classList.add('active');
      render();
    };
  });
}

/* ---------- Auth UI ---------- */
function renderAuth(){
  const area = $('#authArea');
  area.innerHTML = '';
  if (state.user){
    const info = document.createElement('div');
    info.style.display='flex';
    info.style.alignItems='center';
    info.style.gap='8px';
    info.innerHTML = `<div class="muted small">Hi,</div><div style="font-weight:700">${state.user.name}</div><div class="muted small">¬∑</div><div class="role-pill">${state.user.role}</div>`;
    const logout = document.createElement('button');
    logout.className='ghost';
    logout.innerText='Logout';
    logout.onclick = ()=>{ localStorage.removeItem(LS_USER); state.user=null; render(); };
    area.appendChild(info); area.appendChild(logout);
  } else {
    // render login buttons/dropdown
    const btn = document.createElement('button');
    btn.className='btn';
    btn.innerText='Sign In';
    btn.onclick = ()=> openLoginModal();
    area.appendChild(btn);
  }
  $('#roleBadge').innerText = state.user ? state.user.role : 'guest';
}

/* ---------- Modals & small UI bits (simple, built-in) ---------- */
function openLoginModal(){
  const name = prompt('Enter name (demo):', 'student1');
  if (!name) return;
  const role = prompt('Role: student/supervisor/electrician/caretaker/director','student') || 'student';
  const u = { name, username: name, role };
  state.user = u;
  saveUser(u);
  render();
  alert('Signed in as ' + name + ' ('+role+')');
}

/* ---------- Dashboard renderers ---------- */
function render(){
  renderAuth();
  // show view
  const area = $('#contentArea');
  area.innerHTML = '';
  if (!state.user){
    // show welcome + login
    const welcome = document.createElement('div');
    welcome.className = 'glass';
    welcome.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><div style="font-size:20px;font-weight:800">Welcome to Smart Hostel Sentinel</div><div class="muted small">Sign in to start managing</div></div>
      <div><button class="btn" onclick="openLoginModal()">Sign in</button></div>
    </div>`;
    area.appendChild(welcome);
    return;
  }

  if (state.view === 'dashboard') renderDashboard(area);
  if (state.view === 'map') renderMap(area);
  if (state.view === 'issues') renderIssues(area);
  if (state.view === 'ai') renderAI(area);
  if (state.view === 'admin') renderAdmin(area);
}

/* ---------- Dashboard details ---------- */
function computeInsights(){
  // build simple insights
  const rooms = state.rooms;
  const issues = state.issues;
  const open = issues.filter(i=> i.status === 'open');
  // top rooms
  const byRoom = {};
  open.forEach(i=> byRoom[i.room_id] = (byRoom[i.room_id]||0)+1);
  const topRooms = Object.keys(byRoom).sort((a,b)=>byRoom[b]-byRoom[a]).slice(0,5).map(rid=> ({ title: `Repeated open issues in ${rid}`, detail: `${byRoom[rid]} open issues ‚Äî consider maintenance.`}));
  // predictive: simple linear growth estimate for next 7 days based on last 14 days average
  const trend = predictIssueTrend(issues);
  state.insights = [...topRooms, { title: 'Predicted trend', detail: `Estimated ${Math.round(trend.next7)} issues next 7 days (based on recent activity).` }];
}

/* ---------- Simple predictive function ---------- */
function predictIssueTrend(issues){
  // create daily counts for last 30 days
  const days = 30;
  const counts = Array(days).fill(0);
  const now = Date.now();
  issues.forEach(it=>{
    const created = new Date(it.created_at).getTime();
    const diff = Math.floor((now - created) / (24*3600*1000));
    if (diff < days) counts[days-1-diff] += 1;
  });
  // use linear regression (x = day index)
  const x = [], y = [];
  counts.forEach((c,i)=>{ x.push(i); y.push(c); });
  // compute slope
  const n = x.length;
  const sumx = x.reduce((a,b)=>a+b,0), sumy = y.reduce((a,b)=>a+b,0);
  const sumxy = x.reduce((a,b,i)=>a+y[i]*b,0);
  const sumxx = x.reduce((a,b)=>a+b*b,0);
  const slope = (n*sumxy - sumx*sumy) / (n*sumxx - sumx*sumx + 1e-9);
  const intercept = (sumy - slope*sumx)/n;
  // project next 7 days
  let next7 = 0;
  for(let i=n;i<n+7;i++){
    const v = Math.max(0, intercept + slope*i);
    next7 += v;
  }
  return { slope, intercept, next7 };
}

/* ---------- Anomaly detection ---------- */
function detectAnomalies(issues){
  // detect spike: compare last 3 days avg vs previous 7 days avg
  const now = Date.now();
  const getCountRange = (fromDaysAgo, toDaysAgo) => {
    const from = now - toDaysAgo*24*3600*1000;
    const to = now - fromDaysAgo*24*3600*1000;
    return issues.filter(it=> new Date(it.created_at).getTime() >= from && new Date(it.created_at).getTime() <= to).length;
  };
  const last3 = getCountRange(0,3);
  const prev7 = getCountRange(3,10);
  const avgPrev = prev7 / 7;
  if (avgPrev > 0 && (last3 / 3) > avgPrev * 2.0){
    return { alert: true, message: `Spike detected: recent average ${(last3/3).toFixed(1)} > previous {(avgPrev).toFixed(1)}.` };
  }
  return { alert:false };
}

/* ---------- Renderers for each view ---------- */

function renderDashboard(area){
  computeInsights();
  const container = document.createElement('div');
  // stats
  const totalRooms = state.rooms.length;
  const openCount = state.issues.filter(i=>i.status==='open').length;
  const insightsCount = state.insights.length;
  const stats = document.createElement('div');
  stats.className = 'grid-3';
  stats.innerHTML = `
    <div class="glass stat"><div class="stat-icon">üè†</div><div><div class="muted small">Total Rooms</div><div style="font-weight:800;font-size:18px">${totalRooms}</div></div></div>
    <div class="glass stat"><div class="stat-icon">‚ö†Ô∏è</div><div><div class="muted small">Open Issues</div><div style="font-weight:800;font-size:18px">${openCount}</div></div></div>
    <div class="glass stat"><div class="stat-icon">ü§ñ</div><div><div class="muted small">Insights</div><div style="font-weight:800;font-size:18px">${insightsCount}</div></div></div>
  `;
  container.appendChild(stats);

  // main two-column area
  const main = document.createElement('div');
  main.className = 'grid-2';
  // left: live map
  const left = document.createElement('div');
  const leftCard = document.createElement('div'); leftCard.className='glass';
  leftCard.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800">Live Map</div><div class="muted small">Rooms by block/floor</div></div><div style="margin-top:10px" id="mapContainer"></div>`;
  left.appendChild(leftCard);
  // right: AI panel + quick actions
  const right = document.createElement('div');
  const aiCard = document.createElement('div'); aiCard.className='glass';
  aiCard.innerHTML = `<div style="font-weight:800">AI Insights</div><div id="insightsArea" style="margin-top:8px"></div>`;
  const quick = document.createElement('div'); quick.className='glass'; quick.style.marginTop='10px';
  quick.innerHTML = `<div style="font-weight:700">Quick Actions</div><div style="display:flex;gap:8px;margin-top:8px"><button class="small" id="btnOpenMap">Open Map</button><button class="small" id="btnOpenIssues">View Issues</button><button class="small" id="btnRefresh">Refresh</button></div>`;
  right.appendChild(aiCard); right.appendChild(quick);
  main.appendChild(left); main.appendChild(right);

  container.appendChild(main);
  area.appendChild(container);

  // populate map
  renderMapGrid($('#mapContainer'));

  // populate insights
  const insArea = $('#insightsArea');
  insArea.innerHTML = '';
  state.insights.forEach(it=>{
    const div = document.createElement('div'); div.className='insight';
    div.innerHTML = `<div style="font-weight:700">${it.title}</div><div class="muted small">${it.detail}</div>`;
    insArea.appendChild(div);
  });

  // wire quick actions
  $('#btnOpenMap').onclick = ()=>{ state.view='map'; render(); };
  $('#btnOpenIssues').onclick = ()=>{ state.view='issues'; render(); };
  $('#btnRefresh').onclick = ()=>{ refreshLocalState(); alert('Refreshed'); };
}

function renderMap(area){
  // show rooms grouped by block/floor
  const container = document.createElement('div');
  container.className='glass';
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800">Rooms Map</div><div class="muted small">Click a room to report an issue</div></div><div id="mapBlocks" style="margin-top:10px"></div>`;
  area.appendChild(container);
  renderMapGrid($('#mapBlocks'));
}

function renderMapGrid(parent){
  const rooms = state.rooms;
  // group
  const blocks = {};
  rooms.forEach(r=>{ blocks[r.block] = blocks[r.block] || {}; blocks[r.block][r.floor] = blocks[r.block][r.floor] || []; blocks[r.block][r.floor].push(r); });
  parent.innerHTML = '';
  Object.keys(blocks).forEach(b=>{
    const bcard = document.createElement('div'); bcard.style.marginBottom='12px';
    const hdr = document.createElement('div'); hdr.style.display='flex'; hdr.style.justifyContent='space-between'; hdr.innerHTML = `<div style="font-weight:700">Block ${b}</div><div class="muted small">${Object.keys(blocks[b]).length} floors</div>`;
    bcard.appendChild(hdr);
    const grid = document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(auto-fit,minmax(240px,1fr))'; grid.style.gap='10px'; grid.style.marginTop='8px';
    Object.keys(blocks[b]).forEach(fl => {
      const fcard = document.createElement('div'); fcard.className='glass';
      fcard.style.padding='10px';
      fcard.innerHTML = `<div style="display:flex;justify-content:space-between"><div style="font-weight:700">${fl}</div><div class="muted small">${blocks[b][fl].length} rooms</div></div>`;
      const rgrid = document.createElement('div'); rgrid.className='room-grid'; rgrid.style.marginTop='8px';
      blocks[b][fl].forEach(r=>{
        const rc = document.createElement('div');
        rc.className = 'room-card ' + (r.status==='green' ? 'room-green' : r.status==='yellow' ? 'room-yellow' : 'room-red');
        rc.innerText = r.id.split('-').pop();
        rc.title = `${r.id} ‚Äî ${r.status}`;
        rc.onclick = ()=> openReportModal(r);
        rgrid.appendChild(rc);
      });
      fcard.appendChild(rgrid);
      grid.appendChild(fcard);
    });
    bcard.appendChild(grid);
    parent.appendChild(bcard);
  });
}

function renderIssues(area){
  const container = document.createElement('div'); container.className='glass';
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800">Issues</div><div class="muted small">Manage & resolve</div></div>`;
  const list = document.createElement('div'); list.style.marginTop='10px';
  const open = state.issues.filter(i=>i.status==='open');
  if (!open.length) list.innerHTML = '<div class="muted small">No open issues</div>';
  open.forEach(it=>{
    const item = document.createElement('div'); item.className='glass'; item.style.display='flex'; item.style.justifyContent='space-between'; item.style.marginTop='8px';
    item.innerHTML = `<div><div style="font-weight:700">${it.title}</div><div class="muted small">${it.description}</div><div class="muted small">Room: ${it.room_id} ‚Ä¢ Reporter: ${it.reporter}</div></div>`;
    const actions = document.createElement('div');
    const canResolve = ['electrician','supervisor','caretaker'].includes(state.user.role);
    if (canResolve){
      const btn = document.createElement('button'); btn.className='btn'; btn.innerText='Resolve';
      btn.onclick = ()=>{ if(confirm('Mark resolved?')){ resolveIssue(it.id, state.user.name); } };
      actions.appendChild(btn);
    } else {
      actions.innerHTML = `<div class="muted small">No actions for role</div>`;
    }
    item.appendChild(actions);
    list.appendChild(item);
  });
  container.appendChild(list);
  area.appendChild(container);
}

function renderAI(area){
  computeInsights();
  const container = document.createElement('div'); container.className='glass';
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800">AI Dashboard</div><div class="muted small">Predictions & Chat Assistant</div></div>`;
  const inner = document.createElement('div'); inner.style.marginTop='10px';
  // charts area
  const chartsWrap = document.createElement('div'); chartsWrap.style.display='grid'; chartsWrap.style.gridTemplateColumns='1fr 320px'; chartsWrap.style.gap='12px';
  // left: charts
  const left = document.createElement('div'); left.className='glass';
  left.innerHTML = `<div style="font-weight:700">Issue Trends</div><canvas id="trendChart" style="height:200px;margin-top:8px"></canvas><div style="margin-top:8px" id="trendSummary" class="muted small"></div>`;
  // right: chat + heatmap
  const right = document.createElement('div');
  const chat = document.createElement('div'); chat.className='glass';
  chat.innerHTML = `<div style="font-weight:700">AI Assistant</div><div class="muted small">Ask about issues, rooms, or predictions</div><div class="chat-log" id="chatLog"></div><div style="margin-top:8px"><input id="chatInput" class="input" placeholder="Ask: 'show rooms with plumbing issues' or 'predict issues next week'"><div style="display:flex;gap:8px;margin-top:6px"><button class="btn" id="btnAsk">Ask</button><button class="small" id="btnNL">Natural Search</button></div></div></div>`;
  const heat = document.createElement('div'); heat.className='glass'; heat.style.marginTop='10px';
  heat.innerHTML = `<div style="font-weight:700">Heatmap (issue intensity)</div><div style="margin-top:8px" id="heatmapWrap"></div>`;
  right.appendChild(chat); right.appendChild(heat);

  chartsWrap.appendChild(left); chartsWrap.appendChild(right);
  inner.appendChild(chartsWrap);
  container.appendChild(inner);
  area.appendChild(container);

  // draw trend chart (last 30 days)
  drawTrendChart();

  // populate heatmap
  renderHeatmap($('#heatmapWrap'));

  // chat wiring
  $('#btnAsk').onclick = ()=> { const q = $('#chatInput').value.trim(); if (!q) return; handleChat(q); $('#chatInput').value=''; };
  $('#btnNL').onclick = ()=> { const q = $('#chatInput').value.trim(); if (!q) return; handleNaturalSearch(q); $('#chatInput').value=''; };
}

function renderAdmin(area){
  const container = document.createElement('div'); container.className='glass';
  container.innerHTML = `<div style="font-weight:800">Admin Snapshot</div><div class="muted small">Rooms & Issues raw data (first 200 chars)</div><pre style="background:rgba(0,0,0,0.2);padding:10px;border-radius:8px;margin-top:8px">${JSON.stringify({rooms:state.rooms.slice(0,50), issues:state.issues.slice(0,50)}, null, 2)}</pre>`;
  area.appendChild(container);
}

/* ---------- Actions: report / resolve / refresh ---------- */
function openReportModal(room){
  if (!state.user) { alert('Sign in first'); return; }
  // allow student to report, others can add notes - but keep simple
  const title = prompt(`Report Issue for ${room.id} ‚Äî Title:`,'Light not working');
  if (!title) return;
  const desc = prompt('Short description:','Please repair the light.');
  if (!desc) return;
  const sev = prompt('Severity (red or yellow):','yellow') === 'red' ? 'red' :'yellow';
  const issue = { id: uid(), title: title.slice(0,200), description: desc.slice(0,1000), room_id: room.id, reporter: state.user.name, severity: sev, status: 'open', created_at: nowISO(), deadline: addDaysISO(30), resolved_at: null };
  state.issues.unshift(issue);
  saveIssues(state.issues);
  // update room status
  state.rooms = state.rooms.map(r => r.id === room.id ? {...r, status: (sev==='red'?'red':'yellow'), last_updated: nowISO()} : r);
  saveRooms(state.rooms);
  alert('Issue reported (saved locally).');
  render();
}

function resolveIssue(id, resolver){
  state.issues = state.issues.map(it => it.id === id ? {...it, status:'resolved', resolved_at: nowISO(), resolver} : it);
  saveIssues(state.issues);
  // update room
  const issue = state.issues.find(it=>it.id===id);
  if (issue){
    const rId = issue.room_id;
    const openForRoom = state.issues.filter(it=>it.room_id===rId && it.status==='open').length;
    state.rooms = state.rooms.map(r => r.id === rId ? {...r, status: openForRoom===0 ? 'green' : 'yellow', last_updated: nowISO()} : r);
    saveRooms(state.rooms);
  }
  alert('Marked resolved');
  render();
}

function refreshLocalState(){
  state.rooms = loadRooms();
  state.issues = loadIssues();
  computeInsights();
}

/* ---------- Charts ---------- */
function drawTrendChart(){
  const canvas = document.getElementById('trendChart');
  if (!canvas) return;
  // compute daily counts for last 30 days
  const days = 30;
  const labels = [];
  const counts = [];
  for(let i=days-1;i>=0;i--){
    const d = new Date(Date.now() - i*24*3600*1000);
    labels.push(`${d.getMonth()+1}/${d.getDate()}`);
    const cnt = state.issues.filter(it => {
      const diff = Math.floor((Date.now()-new Date(it.created_at).getTime())/(24*3600*1000));
      return diff === i;
    }).length;
    counts.push(cnt);
  }
  // destroy old
  if (state.charts.trend) state.charts.trend.destroy();
  state.charts.trend = new Chart(canvas.getContext('2d'), {
    type: 'line',
    data: { labels, datasets: [{ label:'Issues per day', data: counts, borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.12)', fill:true, tension:0.3 }]},
    options: { responsive:true, plugins:{legend:{display:false}}}
  });
  // summary
  const total = counts.reduce((a,b)=>a+b,0);
  $('#trendSummary').innerText = `Total in last ${days} days: ${total}. Avg/day: ${(total/days).toFixed(2)}.`;
}

/* ---------- Heatmap ---------- */
function renderHeatmap(container){
  // show a small 8x3 grid (block/floor/rooms aggregated)
  container.innerHTML = '';
  const blocks = ['A','B','C'];
  blocks.forEach(b=>{
    const wrap = document.createElement('div'); wrap.style.marginBottom='8px';
    const title = document.createElement('div'); title.innerText = 'Block ' + b; title.style.fontWeight='700'; title.style.marginBottom='6px';
    wrap.appendChild(title);
    const h = document.createElement('div'); h.className='heatmap';
    // 8 rooms per floor (we'll show 8 cells per row representing rooms aggregated intensity)
    for(let i=0;i<8;i++){
      // compute intensity: count open issues for that room index across floors
      let intensity = 0;
      state.rooms.filter(r=>r.block===b).forEach(r=>{
        // map room number to index 1..8
        if (r.number === (i+1)) {
          intensity += state.issues.filter(it=>it.room_id===r.id && it.status==='open').length;
        }
      });
      const div = document.createElement('div'); div.className='heat';
      if (intensity===0) div.style.background='rgba(255,255,255,0.02)';
      else if (intensity===1) div.style.background='rgba(16,185,129,0.3)';
      else if (intensity===2) div.style.background='rgba(250,204,21,0.35)';
      else div.style.background='rgba(239,68,68,0.5)';
      h.appendChild(div);
    }
    wrap.appendChild(h);
    container.appendChild(wrap);
  });
}

/* ---------- Chat Assistant (simple rule-based + NL parsing) ---------- */
function appendChat(who, text){
  const log = $('#chatLog');
  const line = document.createElement('div'); line.style.marginBottom='8px';
  line.innerHTML = `<div style="font-size:12px;color:var(--muted)">${who}</div><div style="padding:8px;border-radius:8px;margin-top:4px;background:rgba(255,255,255,0.02)">${text}</div>`;
  log.appendChild(line); log.scrollTop = log.scrollHeight;
}
function handleChat(q){
  appendChat('You', q);
  // simple patterns
  const lower = q.toLowerCase();
  if (lower.includes('predict') || lower.includes('next week') || lower.includes('forecast')){
    const trend = predictIssueTrend(state.issues);
    const reply = `Prediction: ~${Math.round(trend.next7)} issues in next 7 days (trend slope ${trend.slope.toFixed(2)}). Consider proactive checks on popular rooms.`;
    appendChat('AI', reply); return;
  }
  if (lower.includes('rooms with') || lower.includes('show rooms') || lower.includes('plumbing')){
    // find by keyword in issue descriptions
    const keyword = lower.split('rooms with ')[1] || lower.split('show rooms ')[1] || 'plumb';
    const matches = state.issues.filter(it=> it.description.toLowerCase().includes(keyword) || it.title.toLowerCase().includes(keyword));
    if (!matches.length) { appendChat('AI','No matching issues found for that keyword.'); return; }
    const rooms = [...new Set(matches.map(m=>m.room_id))].slice(0,8);
    appendChat('AI', `Rooms with matching issues: ${rooms.join(', ')}`); return;
  }
  if (lower.includes('which block') || lower.includes('hotspot') || lower.includes('where the most')){
    // top blocks by open issues
    const byBlock = {};
    state.issues.filter(i=>i.status==='open').forEach(it=> {
      const room = state.rooms.find(r=>r.id===it.room_id);
      if (room) byBlock[room.block] = (byBlock[room.block]||0)+1;
    });
    const sorted = Object.keys(byBlock).sort((a,b)=>byBlock[b]-byBlock[a]);
    if (!sorted.length) appendChat('AI','No current open issues.');
    else appendChat('AI', `Hotspot blocks: ${sorted.join(', ')} (counts: ${sorted.map(s=>byBlock[s]).join(', ')})`);
    return;
  }
  // fallback: basic FAQ responses
  if (lower.includes('help') || lower.includes('how to')) appendChat('AI','You can ask for predictions, hotspots, or ask to show rooms with a keyword. Try: "predict issues next week" or "show rooms with water".');
  else appendChat('AI','I did not fully understand. Try asking: "predict issues next week" or "show rooms with plumbing issues".');
}

/* ---------- Natural Language Search (quick) ---------- */
function handleNaturalSearch(q){
  appendChat('You', q);
  const lower = q.toLowerCase();
  if (lower.includes('vacant') || lower.includes('available') || lower.includes('free')){
    const vac = state.rooms.filter(r=>r.status==='green').map(r=>r.id).slice(0,20);
    appendChat('AI', `Vacant rooms (sample): ${vac.join(', ') || 'none'}`);
    return;
  }
  if (lower.includes('floor') || lower.includes('block')){
    // parse e.g., "vacant rooms on floor2 block A"
    const b = (lower.match(/block\s([a-z0-9]+)/) || [])[1];
    const f = (lower.match(/floor\s?(\d)/) || [])[1];
    let res = state.rooms;
    if (b) res = res.filter(r=> r.block.toLowerCase() === b.toLowerCase());
    if (f) res = res.filter(r=> r.floor.toLowerCase() === ('floor'+f).toLowerCase());
    const list = res.map(r=>r.id).slice(0,50);
    appendChat('AI', `Matching rooms: ${list.join(', ')}`);
    return;
  }
  appendChat('AI', 'No structured result for that query. Try "vacant rooms" or "vacant rooms on floor 2".');
}

/* ---------- Misc: Export / Reset ---------- */
$('#btnExport').onclick = ()=> {
  const data = { rooms: state.rooms, issues: state.issues };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'hostel_data.json'; a.click();
  URL.revokeObjectURL(url);
};
$('#btnReset').onclick = ()=> {
  if (!confirm('Reset sample data? This clears local issues and resets rooms.')) return;
  localStorage.removeItem(LS_ROOMS); localStorage.removeItem(LS_ISSUES); seedRoomsIfNeeded(); seedIssuesIfNeeded(); refreshLocalState(); render();
};

/* ---------- Helpers to mount & initial render ---------- */
function init(){
  // map menu role-based visibility
  $all('#menu .side-item').forEach(it=>{
    const roles = it.dataset.roles;
    if (!roles) return;
    if (!state.user) it.style.display='none';
    else {
      const allowed = roles.split(',');
      it.style.display = allowed.includes(state.user.role) ? '' : 'none';
    }
  });
  setupMenu();
  render();
  setStatus('Ready ‚Ä¢ Data in browser');
}
init();

/* ---------- Build initial local state into global state for easy access ---------- */
state.rooms = loadRooms();
state.issues = loadIssues();

/* ---------- On load, compute insights & anomalies ---------- */
computeInsights();
const anomaly = detectAnomalies(state.issues);
if (anomaly.alert) setStatus('ALERT: ' + anomaly.message);

/* ---------- Draw trend & heatmap when switching to AI or dashboard ---------- */
document.addEventListener('click', (e)=>{
  if (e.target && e.target.matches('.side-item[data-view="ai"]')) {
    setTimeout(()=>{ drawTrendChart(); renderHeatmap($('#heatmapWrap')); }, 250);
  }
});

/* ---------- Ensure content area updates after state changes ---------- */
window.render = render;
</script>
</body>
</html>

